## Read this in other languages:

- [English](./README_en.md)
- [中文](./README_cn.md)





## _Идентификация традиционной китайской медицины_

Традиционная китайская медицина, как незаменимый медицинский метод в мировой медицинской системе, в настоящее время все более известна и используется людьми. В этот период традиционная китайская медицина также пережила бурное развитие.Однако типы китайских лекарственных материалов многочисленны и сложны, а обычные люди имеют относительно ограниченные знания об идентификации китайских лекарственных материалов, что может привести к неблагоприятным последствиям, таким как неправильное использование.

-  Токсичность из-за неправильного использования.
- Потеря эффективности.
- лекарственное взаимодействие.
- Вводящая в заблуждение самодиагностика, угроза безопасности
- ✨финансовые потери✨


Эта модель призвана помочь людям, которые не понимают или не понимают традиционную китайскую медицину, легко определить виды традиционной китайской медицины, тем самым избежав вышеуказанной ситуации.

## Конкретная схема кода

> ─── read.py # Чтение данных
> 
> ─── split.py # Классификация данных
> 
> ─── images  # Файлы изображений
> 
> ─── models # Модели
> 
> ─── main.py # Пользовательский интерфейс (эта часть не была завершена при загрузке)
> 
> ─── test.py # Тестирование модели
> 
> ─── train.py # Обучение модели
> 
> ─── chat.py # Перевод языка

## read.py
Основная функция этого кода — анализ количества изображений в каждой подпапке указанной папки и использование библиотеки Matplotlib для создания горизонтальной гистограммы для визуального отображения распределения количества изображений в каждой подпапке. Основные шаги включают в себя:

Подсчитайте количество изображений в каждой подпапке с помощью функции read_flower_data.
Используйте функцию show_bar, чтобы создать гистограмму, которая отображает имена подпапок по оси Y и соответствующее количество изображений по оси X.
Основная цель этого кода — помочь пользователям понять данные изображения в определенной папке, чтобы лучше понять распределение количества изображений в различных подпапках.

Ниже приведен вывод изображения：
![Example Image](https://github.com/whossssssss/ML/blob/google-colab/myplot.png)

## split.py
Основная функция этого кода — разделить набор данных изображения в папке исходных данных на обучающий набор, набор проверки и тестовый набор и скопировать их в разные целевые папки.

функция data_set_split:
- src_data_folder: папка исходных данных, содержащая данные изображения каждой категории.
- target_data_folder: целевая папка, используемая для хранения разделенных наборов данных.
- train_scale, val_scale и test_scale: соотношение обучающего набора, набора проверки и набора тестов, по умолчанию — 0,8, 0,0 и 0,2.

Операции внутри функции:
- Сначала он извлекает все категории в папке исходных данных (категории существуют в виде папок).
- Затем в целевой папке создаются три подпапки: train, val и test для хранения данных изображения обучающего набора, проверочного набора и тестового набора соответственно.
- Далее он перебирает каждую категорию:

> Для каждой категории он меняет порядок данных изображения для этой категории, чтобы обеспечить случайность данных.
Скопируйте изображения в папку обучающего набора, проверочного набора или тестового набора в соответствии с заданным соотношением. Каждое изображение присваивается одному из поднаборов данных в случайном порядке.
Наконец, функция выводит разбивку по каждой категории, включая путь к папке и количество изображений, содержащихся в каждом поднаборе данных.

## train.py
В этом коде выбор модели осуществляется посредством трансферного обучения с использованием предварительно обученной модели MobileNetV2 в качестве базовой модели. Вот основная информация о модели:
- Используемая предварительно обученная модель: MobileNetV2.
- Зафиксируйте базовые веса: base_model.trainable = False, что означает, что веса предварительно обученной модели MobileNetV2 замораживаются и точная настройка не выполняется.
- Пользовательские слои: пользовательский слой глобального среднего пула и выходной слой, добавленные поверх модели MobileNetV2.

Ниже приведен графический вывод обученной модели:
![Example Image](https://github.com/whossssssss/ML/blob/google-colab/train_1.png)
![Example Image](https://github.com/whossssssss/ML/blob/google-colab/train_2.png)

В будущих планах улучшения модели мы будем использовать собственную модель сверточной нейронной сети (CNN), но на момент загрузки она еще не реализована.

## test.py
Загрузите обученную модель и протестируйте ее, чтобы оценить производительность модели на тестовых данных. Результаты испытаний включают потери и точность, которые измеряют производительность модели на новых, ранее неизвестных данных.

Ниже приведены выходные данные тестового набора:
```sh
Found 176 files belonging to 5 classes.
Using 35 files for validation.
Model: "sequential"
_________________________________________________________________
 Layer (type)                Output Shape              Param #   
=================================================================
 rescaling (Rescaling)       (None, 224, 224, 3)       0         
                                                                 
 mobilenetv2_1.00_224 (Func  (None, 7, 7, 1280)        2257984   
 tional)                                                         
                                                                 
 global_average_pooling2d (  (None, 1280)              0         
 GlobalAveragePooling2D)                                         
                                                                 
 dense (Dense)               (None, 5)                 6405      
                                                                 
=================================================================
Total params: 2264389 (8.64 MB)
Trainable params: 6405 (25.02 KB)
Non-trainable params: 2257984 (8.61 MB)
_________________________________________________________________
9/9 [==============================] - 2s 72ms/step - loss: 0.0044 - accuracy: 1.0000
Test accuracy : 1.0
```
## chat.py

ChatTranslator — это класс Python, который использует библиотеку googletrans для перевода текста и определения языка.

### Функции

- **Перевод текста**: Переводит указанный текст на целевой язык.
- **Определение языка**: Определяет язык указанного текста.
- **Обработка запросов**: Обрабатывает текстовые запросы, включая определение языка и перевод.

Этот код определяет класс ChatTranslator, который использует библиотеку googletrans для перевода текста и определения языка, а также использует функцию run_interactive из модуля mimix для получения результатов медицинской диагностики. Основная функция этого кода — перевести пользовательский ввод на китайский язык, получить диагноз, а затем перевести его обратно на язык пользователя.

Когда пользователь вводит запрос, ChatTranslator определяет язык ввода, переводит его на китайский, а затем запускает медицинскую диагностическую модель. После получения диагностических результатов каждый из них переводится обратно на язык пользователя. Таким образом, пользователи могут получать медицинскую диагностику на своем родном языке.

## Пользовательский интерфейс UI

Это начальный пользовательский интерфейс, система предлагает пользователю выбрать изображение и сделать прогноз.

![Пример пользовательского интерфейса](https://github.com/whossssssss/ML/blob/google-colab/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202023-11-12%20191311.png)

Когда модель получает изображение (поддерживаются распространенные форматы изображений, такие как jpg, jpeg, png и т.д.), интерфейс делает прогноз по изображению.

![Пример пользовательского интерфейса](https://github.com/whossssssss/ML/blob/google-colab/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202023-11-12%20191324.png)
![Пример пользовательского интерфейса](https://github.com/whossssssss/ML/blob/google-colab/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202023-11-12%20191331.png)
![Пример пользовательского интерфейса](https://github.com/whossssssss/ML/blob/google-colab/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202023-11-12%20191800.png)
![Пример пользовательского интерфейса](https://github.com/whossssssss/ML/blob/google-colab/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202023-11-12%20191807.png)

Ниже приведен пример динамического отображения:
![Пример изображения](https://github.com/whossssssss/ML/blob/google-colab/2378fe0a-ae7c-4874-beed-58958a718585.gif)

## Детали обучения текстовой диалоговой модели

Модель основана на архитектуре кодировщика-декодера Transformer. Эта модель имеет 216 миллионов параметров, 12 слоев, размер модели (d_model) 768 и использует 12 голов внимания (n_heads). Обучающие данные включают 2,7 миллиона образцов, размер данных составляет 1,38 ГБ.

Набор данных для обучения модели поступает из "Huatuo-26M", это крупномасштабный китайский медицинский QA-датасет. Этот набор данных был собран из нескольких источников:

- Онлайн-консультации по медицине: собраны многочисленные записи онлайн-консультаций с медицинскими экспертами с сайта онлайн-консультаций "QianwenHealth". Каждая запись - это пара вопрос-ответ: пациент задает вопрос, а доктор отвечает. С этого сайта напрямую было извлечено 31 677 604 пары вопрос-ответ. После удаления пар с особыми символами и повторяющихся пар в итоге было получено 25 341 578 пар​​.
- Медицинская энциклопедия: с китайской Википедии было собрано 8699 статей об заболеваниях и 2736 статей о лекарствах, а также с сайта "Qianwen Health" было извлечено 226 432 качественных медицинских статьи. После структурирования этих статей каждая статья была разделена на пары заголовок-абзац, затем на основе этих заголовков были разработаны шаблоны для преобразования каждого заголовка в вопрос, который может быть ответом на соответствующий абзац. В итоге были сгенерированы пары вопрос-ответ на основе этих заголовков и шаблонов​​.
- Медицинские базы знаний: из нескольких существующих медицинских баз знаний были извлечены медицинские вопросы и ответы. Эти базы знаний включают CPubMed-KG (граф знаний китайской медицинской литературы, основанный на масштабных медицинских литературных данных Китайской медицинской ассоциации), 39Health-KG и Xywy-KG (два открытых графа знаний). Из этих баз знаний были очищены и объединены сущности и отношения между сущностями, в результате чего было получено 798 444 пары вопрос-ответ​​.

Набор данных "Huatuo-26M" охватывает множество источников данных, от реальных медицинских консультаций и медицинской энциклопедии до профессиональных медицинских баз знаний, что делает его не только масштабным, но и богатым содержанием, охватывающим широкий спектр тем и знаний в области медицины. Такой набор данных обеспечивает прочную основу для обучения китайской модели медицинского QA​​.

###### Медицинская диагностика (чат)
Эта модель медицинской диагностики использует весовые файлы `med_base_conf` из библиотеки mimix и модель `med.base.model`, оптимизированные на основе локальных корпусов и тестовых данных.

Большинство диагностических ответов основаны на взглядах традиционной китайской медицины, например, "застой энергии и крови", "укрепление основы и питание источника" и так далее. Рецепты также в основном используют традиционные китайские лекарства или пищевые методы лечения, например, китайские готовые лекарства, такие как "Маленькая активирующая пилюля, четыре рассеивающих пилюли" или советы по питанию, такие как "рекомендуется чаще есть морковь, морские водоросли, лилии и т.д., для лечения влажности в печени и желчном пузыре".

На основе повторной обучения на локальном корпусе, помимо традиционных китайских методов диагностики и рецептов, были добавлены некоторые западные медицинские рецепты, такие как "местное применение хлорамфениколовых глазных капель для лечения конъюнктивита", "применение левофлоксацина для лечения кератита" и так далее, что делает диагностику более точной и целенаправленной, а лечение - более разнообразным и эффективным.

Пользователи могут выбирать язык вопросов и ответов, и язык ответов будет соответствовать языку вопросов пользователя, что делает использование более удобным для пользователя.
###### Обратите внимание, что модель медицинской диагностики имеет только справочное значение и не может заменить диагностику врача. Пожалуйста, обратитесь в больницу для получения более подробной диагностики.

Ниже приведен пример работы модели медицинской диагностики:

![Пример пользовательского интерфейса](https://github.com/whossssssss/ML/blob/google-colab/show_2.gif)


